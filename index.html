<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Apiary Locations and Percent of Pollination Dependant Crops per CA County</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">
    <style>
    html, body, #map { width: 100%; height: 100%; margin: 0; background: #fff; }
    .legend {
line-height: 40px;
font-family: 'Titillium Web', sans-serif;
font-size: 16px;
width: 190px;
color: #333333;
padding: 6px 8px;
background: #fffde7; /* very pale yellow */
background: rgba(255,253,231,0.85); /* pale yellow with slight transparency */
box-shadow: 0 0 15px rgba(0,0,0,0.2);
border-radius: 5px;
}
.legend i {
width: 20px;
height: 20px;
float: left;
margin-right: 8px;
opacity: 0.9;
}
.legend img {
width: 16px;
height: 16px;
margin-right: 3px;
float: left;
}
.legend p {
font-size: 14px;
line-height: 20px;
margin: 0;
}
    .info-box { width: 320px; font-size: 13px; line-height: 1.3; }
    /* Title box: wider and slightly larger text than default legend */
    .title-box { width: 420px; font-size: 20px; font-weight: 700; line-height: 1.1; padding: 8px 10px; }
    /* Ensure long URLs and text wrap inside legend/info boxes */
    .legend, .legend p, .legend a, .info-box, .info-box a {
        overflow-wrap: anywhere;
        word-break: break-word;
        hyphens: auto;
    }
    </style>
    <script src="https://unpkg.com/leaflet@1.7.0/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
</head>
<body>
<!-- Our web map and content will go here -->
<div id="map"></div>
<script>
// 1. Create a map object.
var mymap = L.map('map', {
    center: [37.001345, -119.914961], //note that we've centered the map to downtown AVL
    zoom: 6, //this line adjusts the starting zoom level of the map
    maxZoom: 18,//this line sets the maximum zoom level
    minZoom: 2,//this line sets the minimum zoom level
    detectRetina: true // detect whether the sceen is high resolution or not.
});

// 2. Add a base map.
var Stadia_AlidadeSmoothDark = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.{ext}', {
    minZoom: 0,
    maxZoom: 20,
    attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Map Author: Alexandra Brand',
    ext: 'png'
});
Stadia_AlidadeSmoothDark.addTo(mymap);

// 3. Load apiary point locations and CA county choropleth
// Create a CSS class for apiary markers (honey color)
var apiaryMarkerCss = '.marker-apiary { color: #f39c12; font-size: 18px !important; line-height: 20px; width: 26px; height: 26px; display: inline-block; text-align: center; } .marker-apiary i { color: inherit; font-size: inherit; line-height: inherit; }';
$('head').append('<style>' + apiaryMarkerCss + '</style>');

// Get apiaries GeoJSON and put it on the map using pointToLayer to create custom markers
var apiaries = L.geoJson.ajax('assets/apiaries_locations.geojson', {
    pointToLayer: function(feature, latlng) {
        var icon = L.divIcon({
            className: 'marker-apiary',
            html: '<i class="fa-solid fa-box-archive"></i>',
            iconSize: [26, 26],
            iconAnchor: [13, 13]
        });

        var marker = L.marker(latlng, { icon: icon });
        // Popup: show only the number of hives (or N/A)
        var props = feature && feature.properties ? feature.properties : {};
        function getHivesFromProps(p) {
            if (!p) return null;
            var keys = ['Number of hives','Number of Hives','hives','Hives','Hive_Count','HiveCount','num_hives','number_of_hives','N_Hives','HiveQty','Quantity','count','NUM_HIVES'];
            for (var i = 0; i < keys.length; i++) {
                if (p.hasOwnProperty(keys[i]) && p[keys[i]] !== null && p[keys[i]] !== '') {
                    var v = Number(p[keys[i]]);
                    if (!isNaN(v)) return v;
                }
            }
            return null;
        }
        var hives = getHivesFromProps(props);
        var popupContent = (hives !== null && hives !== undefined) ? ('Hives: ' + String(hives)) : 'Hives: unknown';
        marker.bindPopup(popupContent);
        return marker;
    }
}).addTo(mymap);

// Use a green color ramp for percent values
var colors = chroma.scale('Greens').colors(6);

// Helper: try multiple possible property names to find the percent pollinator-dependent crops value
function getPercent(feature) {
    if (!feature || !feature.properties) return 0;
    var p = feature.properties;
    var keys = [
        'Percent pollinator dependant crops',
        'Percent_pollinator_dependant_crops',
        'percent_pollinator',
        'Percent',
        'PERCENT',
        'percent',
        'Pcnt_poll_dep',
        'pct_poll_dep'
    ];
    for (var i = 0; i < keys.length; i++) {
        if (p.hasOwnProperty(keys[i]) && p[keys[i]] !== null && p[keys[i]] !== '') {
            return Number(p[keys[i]]);
        }
    }
    // try to find a numeric property that looks like a percent (0-100)
    for (var k in p) {
        if (!isNaN(Number(p[k]))) {
            var v = Number(p[k]);
            if (v >= 0 && v <= 100) return v;
        }
    }
    return 0;
}

function setColor(percent) {
    var id = 0;
    if (percent > 40) id = 5;
    else if (percent > 20) id = 4;
    else if (percent > 10) id = 3;
    else if (percent > 5) id = 2;
    else if (percent > 0) id = 1;
    else id = 0;
    return colors[id];
}

function style(feature) {
    var d = getPercent(feature) || 0;
    return {
        fillColor: setColor(Number(d) || 0),
        fillOpacity: 0.7,
        weight: 1,
        opacity: 1,
        color: '#b4b4b4'
    };
}

// Popup for each county polygon
function onEachFeature(feature, layer) {
    var props = feature.properties || {};
    var percent = getPercent(feature);
    var countyName = props.NAME || props.County || props.COUNTY || props.county || props.NAME_1 || '';
    var pctText = (percent !== null && percent !== undefined) ? Number(percent).toLocaleString() + '%' : 'N/A';
    var title = countyName ? '<b>' + countyName + '</b><br/>' : '';
    layer.bindPopup(title + '<b>Percent pollinator-dependent crops:</b> ' + pctText);
}

L.geoJson.ajax("assets/ca_county_FINAL.geojson", {
    style: style,
    onEachFeature: onEachFeature
}).addTo(mymap);

// 9. Create Leaflet Control Object for Legend
var legend = L.control({position: 'topright'});
// 10. Function that runs when legend is added to map
legend.onAdd = function () {
// Create Div Element and Populate it with HTML
var div = L.DomUtil.create('div', 'legend');
//this line creates a title for the choropleth part of the legend
div.innerHTML += '<b>Percent Pollinator-Dependent Crops</b><br />';
// color breaks for percentage ranges
div.innerHTML += '<i style="background: ' + colors[5] + '; opacity: 0.6"></i><p>> 40%</p>';
div.innerHTML += '<i style="background: ' + colors[4] + '; opacity: 0.6"></i><p>21-40%</p>';
div.innerHTML += '<i style="background: ' + colors[3] + '; opacity: 0.6"></i><p>11-20%</p>';
div.innerHTML += '<i style="background: ' + colors[2] + '; opacity: 0.6"></i><p>6-10%</p>';
div.innerHTML += '<i style="background: ' + colors[1] + '; opacity: 0.6"></i><p>1-5%</p>';
div.innerHTML += '<i style="background: ' + colors[0] + '; opacity: 0.6"></i><p>0%</p>';
// marker legend for apiary points
div.innerHTML += '<hr><b>Apiary Locations</b><br />';
div.innerHTML += '<p style="font-size:12px;margin:4px 0 6px 0;"><em>(Click locations to see number of hives)</em></p>';
div.innerHTML += '<i class="fa-solid fa-box-archive marker-apiary"></i><p>Apiary</p>';
// Return the Legend div containing the HTML content
return div;
};
// 11. Add a legend to map
legend.addTo(mymap);

L.control.scale({position: 'bottomleft'}).addTo(mymap);

// Title box (large, styled like the legend)
var titleControl = L.control({position: 'topleft'});
titleControl.onAdd = function(map) {
    var div = L.DomUtil.create('div', 'legend title-box');
    div.innerHTML = '<div>California pollination-dependant crop percentage by county and Apiary locations</div>';
    L.DomEvent.disableClickPropagation(div);
    L.DomEvent.disableScrollPropagation(div);
    return div;
};
titleControl.addTo(mymap);

// Left-side informational box (styled like legend)
var infoBox = L.control({position: 'topleft'});
infoBox.onAdd = function(map) {
    var div = L.DomUtil.create('div', 'legend info-box');
    div.innerHTML = '' +
        '<b>Notes</b>' +
        '<div style="margin-top:6px">' +
        '<p>Percentage of pollinator dependant crops is based on the percent of the total acreage of each county that is dedicated to growing Almonds, Cherries, Melons, Avocados, Apples, Blueberries, and Olives.</p>' +
        '<p><strong>Data Source:</strong> <a href="https://www.nass.usda.gov/Statistics_by_State/California/Publications/AgComm/2022/2022_county_agricultural_commissioner_report_revised.pdf" target="_blank">NASS CA 2022 County Ag Commissioner Report (revised)</a></p>' +
        '<p>The Apiary locations are both commercial and private.</p>' +
        '<p><strong>Data Sources:</strong><br /><a href="https://apiarymap.com" target="_blank">apiarymap.com</a><br /><a href="https://beecounted.org/map" target="_blank">beecounted.org/map</a></p>' +
        '<p>This map was inspired by this article: <a href="https://ers.usda.gov/data-products/charts-of-note/chart-detail?chartId=107088#:~:text=The%20California%2Dgrown%20almonds%20in,2%2C000%20miles%20to%20pollinate%20almonds." target="_blank">https://ers.usda.gov/data-products/charts-of-note/chart-detail?chartId=107088#:~:text=The%20California%2Dgrown%20almonds%20in,2%2C000%20miles%20to%20pollinate%20almonds.</a></p>' +
        '</div>';
    // prevent map interactions when cursor over the box
    L.DomEvent.disableClickPropagation(div);
    L.DomEvent.disableScrollPropagation(div);
    return div;
};
infoBox.addTo(mymap);
</script>
</body>
</html>